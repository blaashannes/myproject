<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ALUSTART Fastener Take‑Off Calculator</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#d1d5db; /* slate-500 */
      --card:#0b1222; /* deep blue-ish */
      --accent:#22d3ee; /* cyan-400 */
      --accent-2:#14b8a6; /* teal-500 */
      --good:#22c55e; /* green-500 */
      --warn:#f59e0b; /* amber-500 */
      --bad:#ef4444;  /* red-500 */
      --text:#ffffff; /* brighter text */ /* gray-200 */
      --soft:#cbd5e1; /* slate-300 */
      --border:#243149;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#0b1020);
      color:var(--text); font: 16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      min-height:100vh;
    }
    header{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      padding:16px 20px; position:sticky; top:0; backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(90deg,#0b1020EE,#0b1222EE);
      border-bottom:1px solid var(--border);
      z-index:5;
    }
    header .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:26px; filter:invert(1) brightness(2) contrast(100%)} /* force white */
    .brand a{color:var(--soft);text-decoration:none;font-weight:600}
    .brand a:hover{color:white}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border); background:#0c1630; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:.2px;}
    .btn:hover{border-color:#33507a}
    .btn.accent{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#001014; border-color:transparent}
    .btn.warn{background:#272107; border-color:#3e3206}
    .btn.ghost{background:#0b1120}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px 80px}
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:linear-gradient(180deg,#0b1222,#0a1428);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .card h2{margin:0;padding:16px 16px;border-bottom:1px solid var(--border);font-size:18px;color:#f8fafc}
    .card .content{padding:16px}
    @media (min-width:980px){
      .col-4{grid-column:span 4}
      .col-6{grid-column:span 6}
      .col-8{grid-column:span 8}
      .col-12{grid-column:span 12}
    }
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    label{font-size:11px;color:#cbd5e1;display:block;margin-bottom:6px} /* brighter labels */
    input[type="number"], input[type="text"], select{
      width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#0b162e; color:var(--text);
    }
    input[type="checkbox"]{transform:scale(1.05)}
    table{width:100%; border-collapse:collapse;}
    thead th{position:sticky; top:64px; background:#0b1222; border-bottom:1px solid var(--border); padding:10px; font-size:12px; color:var(--soft);}
    tbody td{border-bottom:1px dashed #15213a; padding:6px 8px; vertical-align:middle}
    tfoot td{padding:12px 8px; border-top:1px solid var(--border)}
    .num{text-align:right; white-space:nowrap}
    .pill{padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#0b162e;}
    .muted{color:var(--muted)}
    .hint{font-size:14px;color:#e5e7eb}
    .warnmsg{color:#fde68a}
    .badmsg{color:#fecaca}
    .goodmsg{color:#bbf7d0}
    .footer{margin-top:12px; font-size:12px; color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .tile{background:#0a1428;border:1px solid var(--border);border-radius:12px;padding:12px}
    .tile .big{font-size:22px; font-weight:800}
    .tile .lbl{font-size:12px;color:var(--muted)}
    .tag{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0b162e; margin-left:6px}
    .sr{position:absolute;left:-9999px}
    .right{justify-self:end}
    .del{background:#2a0f12;border-color:#551822}
    .del:hover{border-color:#7a2433}
    /* Cards layout for runs */
    .runlist{display:grid;gap:14px}
    .run-card{background:#0a1428;border:1px solid var(--border);border-radius:12px;padding:10px}
    .run-card .grid{display:grid;gap:8px}
    @media(min-width:720px){ .run-card .grid{grid-template-columns:repeat(6,1fr)} }
    @media(min-width:1100px){ .run-card .grid{grid-template-columns:repeat(8,1fr)} }

    /* --- Rothoblaas top bar --- */
    .topbar{
      position:relative;
      width:100%;
      background:#0b1220;                       /* same dark header as the calculator */
      border-bottom:1px solid rgba(148,163,184,.18);
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brandlogo{ height:36px; width:auto; display:block; filter:brightness(0) invert(1); }
    /* ^ forces the black SVG to render white on dark backgrounds */
    .brandlogo--top{ height:36px; }

    .homeLink{ display:inline-flex; align-items:center; text-decoration:none; }
    .backlink{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid #334155;
      border-radius:9999px;
      text-decoration:none;
      color:#f8fafc; background:#0b1220;
    }
    .backlink:hover{ background:#111827; }

    /* Optional sticky header */
    .topbar{ position:sticky; top:0; z-index:1000; }

    /* Compact mode overrides to reduce wasted space */
    body.compact .run-card{padding:6px 8px}
    body.compact .run-card .head{margin-bottom:6px}
    body.compact label{font-size:11px}
    body.compact input[type="number"], body.compact input[type="text"], body.compact select{padding:8px 10px; border-radius:8px; font-size:14px}
    body.compact .run-card .grid{gap:8px}
    @media(min-width:980px){ body.compact .run-card .grid{grid-template-columns:repeat(8, minmax(110px,1fr))} }

    /* Drag/drop SKU strip */
    .sku-strip{display:flex;gap:8px;flex-wrap:wrap}
    .sku-pill{user-select:none; display:inline-flex; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#0b162e; font-size:12px; cursor:grab}
    .sku-pill:active{cursor:grabbing}
    .drop-target{outline:2px dashed var(--accent); outline-offset:2px}
  </style>
</head>
<body>
  <div class="topbar">
    <a class="homeLink" href="https://blaashannes.github.io/myproject/" title="Go to homepage">
      <img class="brandlogo brandlogo--top"
           src="https://www.rothoblaas.com/assets/images/rothoblaas-logo.svg"
           alt="Rothoblaas logo">
    </a>
    <a class="backlink" href="https://blaashannes.github.io/myproject/" aria-label="Back to start page">
      ← Back to start
    </a>
  </div>
  <header>
    <div class="brand">
      <a href="https://blaashannes.github.io/myproject/" title="Back to MyProject home" aria-label="Home">
        <img src="https://www.rothoblaas.com/assets/images/rothoblaas-logo.svg" alt="Rothoblaas logo" />
      </a>
      <span class="pill">ALUSTART Fastener Take‑Off</span>
    </div>
    <div class="actions">
      <button class="btn" id="saveBtn" title="Save inputs in this browser">Save</button>
      <button class="btn" id="loadBtn" title="Load saved inputs">Load</button>
      <button class="btn" id="resetBtn" title="Clear all inputs">Reset</button>
      <button class="btn" id="csvBtn" title="Export a CSV of runs and totals">Export CSV</button>
      <button class="btn accent" id="printBtn" title="Print / PDF">Print</button>
    </div>
  </header>

  <div class="wrap">
    <div class="cards">
      <section class="card col-12">
        <h2>Project Settings</h2>
        <div class="content grid cols-4">
          <div>
            <label for="job">Job / Project name</label>
            <input id="job" type="text" placeholder="e.g., Oak Street CLT Core"/>
          </div>
          <div>
            <label for="sku_alustart">ALUSTART profile SKU</label>
            <div class="grid" style="gap:8px">
              <select id="sku_alustart_select" aria-label="Select ALUSTART SKU">
                <option value="">— Select SKU —</option>
                <option>ALUSTART80</option>
                <option>ALUSTART100</option>
                <option>ALUSTART120</option>
                <option>ALUSTART140</option>
                <option>ALUSTART160</option>
                <option value="__custom">Other / custom…</option>
              </select>
              <!-- Hidden text field that always stores the chosen value for save/export -->
              <input id="sku_alustart" type="text" placeholder="e.g., ALUSTART120" title="Custom ALUSTART SKU" style="display:none"/>
              <div class="sku-strip" id="sku_strip" aria-label="Drag a SKU onto the selector or custom box"></div>
            </div>
          </div>
          <div>
            <label for="sku_membrane">Membrane SKU</label>
            <input id="sku_membrane" type="text" placeholder="e.g., STARTBAND / PROTECT"/>
          </div>
          <div>
            <label for="nail_gun">Nail gun (for LBA460)</label>
            <select id="nail_gun">
              <option value="">— Select —</option>
              <option value="ATEU0116">ATEU0116 impact nail gun → LBA34PLA460</option>
              <option value="HH3522">HH3522 nail gun → LBA25PLA460</option>
            </select>
          </div>
          <div>
            <label for="waste">Waste factor (bars)</label>
            <input id="waste" type="number" min="0" step="0.01" value="0.05" />
            <div class="hint">Fraction (e.g., 0.05 = 5%) applied to bar count.</div>
          </div>
          <div>
            <label for="corners">90° corners <span class="muted">(JIGSTARTL)</span></label>
            <input id="corners" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="tees">T‑intersections <span class="muted">(counted as ×2 JIGSTARTL)</span></label>
            <input id="tees" type="number" min="0" step="1" value="0" />
          </div>
        </div>
        <div class="content">
          <div class="grid cols-4">
            <div>
              <span class="lbl">Constants</span>
              <div class="hint">Bar length <strong id="bl">7.874</strong> ft · Anchors/bar <strong id="apb">12</strong> · Jig interval <strong id="ji">2.297</strong> ft</div>
            </div>
            <div class="muted">
              <div><span class="pill">Fastener patterns → density (pcs/ft)</span></div>
              <div class="hint">TOTAL 22 · P1 11 · P2 8 · P3 6</div>
            </div>
            <div class="muted">
              <div><span class="pill">Fasteners</span></div>
              <div class="hint">Concrete side: <strong>SKREVO12100</strong>. Timber side: <strong>LBA460</strong> nails or <strong>LBS560</strong> screws. For LBA460: ATEU0116 ⇒ <strong>LBA34PLA460</strong>, HH3522 ⇒ <strong>LBA25PLA460</strong>.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card col-12">
        <h2>Fastener Pattern Guide</h2>
        <div class="content">
          <div class="grid cols-2">
            <div>
              <img src="https://github.com/blaashannes/myproject/blob/main/images/ALUSTART%20Nail%20Pattern.png?raw=true" alt="ALUSTART fastener pattern guide" style="max-width:100%;border-radius:12px;border:1px solid var(--border)"/>
            </div>
            <div class="hint" style="font-size:14px;color:#e2e8f0">
              <p><strong>Fastener pattern</strong> controls how many timber‑side fasteners (LBA nails or LBS screws) are used per foot along the ALUSTART profile:</p>
              <ul>
                <li><strong>TOTAL</strong> – every hole (≈ 22 pcs/ft)</li>
                <li><strong>Pattern 1 (P1)</strong> – every 2nd hole (≈ 11 pcs/ft)</li>
                <li><strong>Pattern 2 (P2)</strong> – every 3rd hole (≈ 8 pcs/ft)</li>
                <li><strong>Pattern 3 (P3)</strong> – every 4th hole (≈ 6 pcs/ft)</li>
              </ul>
              <p class="muted">Note: For solid timber/glulam (C/GL) under F2/3 shear, avoid the TOTAL pattern.</p>
            </div>
          </div>
        </div>
      </section>

      <section class="card col-12">
        <h2>Wall Runs</h2>
        <div class="content">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px">
            <div class="hint">One card per straight wall segment. Anchor spacing uses <strong>hole multiples</strong> (~7.9 in).</div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn ghost" id="addRowBtn" title="Add a new wall run">+ Add run</button>
              <button class="btn ghost" id="toggleCompact" title="Toggle compact layout">Compact layout</button>
            </div>
          </div>
          <div id="runlist" class="runlist"></div>
          <div class="footer" style="margin-top:12px">
            <div class="kpi">
              <div class="tile"><div class="lbl">Total timber fasteners</div><div class="big" id="totTimber">0</div></div>
              <div class="tile"><div class="lbl">Total anchors</div><div class="big" id="totAnch">0</div></div>
              <div class="tile"><div class="lbl">Validation</div><div class="big" style="font-size:14px" id="validation">—</div></div>
            </div>
          </div>
        </div>
      </section>

      <section class="card col-12">
        <h2>Results</h2>
        <div class="content">
          <div class="kpi">
            <div class="tile">
              <div class="lbl">Total perimeter length</div>
              <div class="big" id="k_total_len">0.0 ft</div>
            </div>
            <div class="tile">
              <div class="lbl">ALUSTART bars (with waste)</div>
              <div class="big" id="k_bars">0</div>
              <div class="hint">Bar length 7.874 ft</div>
            </div>
            <div class="tile">
              <div class="lbl">Concrete fasteners (SKREVO12100)</div>
              <div class="big" id="k_anchors">0</div>
              <div class="hint">Capped by available holes</div>
            </div>
            <div class="tile">
              <div class="lbl">Membrane under profile</div>
              <div class="big" id="k_membrane">0.0 ft</div>
            </div>
          </div>
          <div class="kpi" style="margin-top:12px">
            <div class="tile">
              <div class="lbl">Timber fasteners (LBA460 nails)</div>
              <div class="big" id="k_lba">0</div>
            </div>
            <div class="tile">
              <div class="lbl">Timber fasteners (LBS560 screws)</div>
              <div class="big" id="k_lbs">0</div>
            </div>
            <div class="tile">
              <div class="lbl">HBS screws @ ~11.8 in</div>
              <div class="big" id="k_hbs">0</div>
              <div class="hint">Model: HBS880</div>
            </div>
            <div class="tile">
              <div class="lbl">JIGSTARTI (linear)</div>
              <div class="big" id="k_jigi">0</div>
              <div class="hint">≈ every 2.297 ft</div>
            </div>
          </div>
          <div class="kpi" style="margin-top:12px">
            <div class="tile">
              <div class="lbl">JIGSTARTL (corners & T)</div>
              <div class="big" id="k_jigl">0</div>
              <div class="hint">Corners + 2 × T‑intersections</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card col-12">
        <h2>Order Summary</h2>
        <div class="content">
          <div class="hint" style="margin-bottom:8px">Auto-filled; you can edit codes before exporting CSV.</div>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Product</th><th>Code</th><th class="num">Quantity</th></tr>
              </thead>
              <tbody id="orderBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card col-12">
        <h2>Notes</h2>
        <div class="content">
          <ul class="hint">
            <li>Per‑ft nailing densities: TOTAL 22; PATTERN 1 = 11; PATTERN 2 = 8; PATTERN 3 = 6.</li>
            <li>Anchors per run: <em>1 + floor((run_mm − 2 × edge_mm) / spacing_mm)</em>, min 0.</li>
            <li>For C/GL (solid/glulam) under F2/3 shear, avoid the TOTAL pattern. The calculator flags this.
            </li>
            <li>Resin for chemical anchors is not computed here; use your anchor system’s volume tables.</li>
          </ul>
        </div>
      </section>

      <!-- Developer test harness (collapsible) -->
      <section class="card col-12">
        <h2>Developer Tests</h2>
        <div class="content">
          <details>
            <summary class="hint">Run internal tests</summary>
            <button class="btn" id="runTestsBtn">Run tests</button>
            <div id="testOutput" class="hint" style="margin-top:8px"></div>
          </details>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ======== Constants ========
    const BAR_LENGTH_FT = 7.874; // 2400 mm
    const ANCHORS_PER_BAR = 12;
    const JIG_INTERVAL_FT = 2.297; // JIGSTARTI typical spacing
    const MM_PER_FT = 304.8;
    const HBS_SPACING_MM = 300; // ≈11.8 in big-hole HBS880 spacing

    // Pattern densities (pcs/ft)
    const DENSITY = {
      "TOTAL": 22,
      "PATTERN 1": 11,
      "PATTERN 2": 8,
      "PATTERN 3": 6
    };

    // Panel types
    const PANEL_TYPES = ["CLT","C/GL","Timber Frame"]; // C/GL = Solid/Glulam
    const FASTENER_TYPES = ["LBA460 nails","LBS560 screws"]; // Timber-side fasteners
    const PATTERNS = Object.keys(DENSITY);

    // ======== DOM helpers ========
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // ======== Row management ========
    const runlist = document.querySelector('#runlist');

    function newRowData(i){
      return {
        name: `Run ${i+1}`,
        length_ft: 10,
        panel: "CLT",
        fastener: "LBA460 nails",
        pattern: "TOTAL",
        spacing_mm: 200,
        edge_mm: 100
      };
    }

    function addRow(prefill){
      const i = runlist.children.length;
      const data = prefill || newRowData(i);
      const card = document.createElement('div');
      card.className = 'run-card';
      card.innerHTML = `
        <div class="grid">
          <div>
            <label>Run name</label>
            <input data-field="name" type="text" value="${data.name}" aria-label="run name">
          </div>
          <div>
            <label>Length (ft)</label>
            <input data-field="length_ft" type="number" min="0" step="0.001" value="${data.length_ft}">
          </div>
          <div>
            <label>Panel</label>
            <select data-field="panel">${PANEL_TYPES.map(p=>`<option ${p===data.panel?'selected':''}>${p}</option>`).join('')}</select>
          </div>
          <div>
            <label>Fastener</label>
            <select data-field="fastener">${FASTENER_TYPES.map(f=>`<option ${f===data.fastener?'selected':''}>${f}</option>`).join('')}</select>
          </div>
          <div>
            <label>Fastener pattern</label>
            <select data-field="pattern">${PATTERNS.map(p=>`<option ${p===data.pattern?'selected':''}>${p}</option>`).join('')}</select>
          </div>
          <div>
            <label>Anchor spacing</label>
            <select data-field="spacing_mm">
              <option value="200" ${data.spacing_mm===200?'selected':''}>Every hole (~7.9 in)</option>
              <option value="400" ${data.spacing_mm===400?'selected':''}>2nd hole (~15.7 in)</option>
              <option value="600" ${data.spacing_mm===600?'selected':''}>3rd hole (~23.6 in)</option>
              <option value="800" ${data.spacing_mm===800?'selected':''}>4th hole (~31.5 in)</option>
              <option value="1000" ${data.spacing_mm===1000?'selected':''}>5th hole (~39.4 in)</option>
              <option value="1200" ${data.spacing_mm===1200?'selected':''}>6th hole (~47.2 in)</option>
            </select>
          </div>
          <div>
            <label>Edge setback (mm)</label>
            <input data-field="edge_mm" type="number" min="0" step="1" value="${data.edge_mm}">
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn del" title="Delete run">Delete</button>
          </div>
          <div class="calc-badges" style="grid-column:1/-1">
            <span class="badge">Timber fasteners: <strong data-cell="timber">0</strong></span>
            <span class="badge">Anchors: <strong data-cell="anchors">0</strong></span>
          </div>
        </div>
      `;
      runlist.appendChild(card);
      card.addEventListener('input', computeAll);
      card.querySelector('.del').addEventListener('click', ()=>{ card.remove(); computeAll(); });
      computeAll();
    }

    // ======== Math helpers ========
    const toNumber = v => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const ceil = Math.ceil; const floor = Math.floor; const max = Math.max; const min = Math.min;
    function roundup(n){ return Math.ceil(n); }

    // Anchors for a run: 1 + floor((L_mm - 2E)/S), min 0
    function anchorsPerRun(length_ft, spacing_mm, edge_mm){
      const Lmm = length_ft * MM_PER_FT;
      const usable = Lmm - 2*edge_mm;
      if (usable < 0) return 0;
      return max(0, 1 + floor( usable / spacing_mm ));
    }

    // Timber fasteners per run = roundup(length_ft * density)
    function timberPerRun(length_ft, pattern){
      const d = DENSITY[pattern] || 0;
      return roundup(length_ft * d);
    }
    function hbsPerRun(length_ft, edge_mm){
      const Lmm = length_ft * MM_PER_FT;
      const usable = Lmm - 2*edge_mm;
      if (usable < 0) return 0;
      return max(0, 1 + floor( usable / HBS_SPACING_MM ));
    }

    // ======== Compute ========
    function computeAll(){
      let totalLen = 0;
      let totalAnch = 0;
      let totalHBS = 0;
      let totalTimber = 0;
      let totalLBA = 0;
      let totalLBS = 0;
      let warnings = [];

      // Per-row calculations
      $$('.run-card').forEach(tr =>{
        const nameI = tr.querySelector('[data-field="name"]');
        const lenI = tr.querySelector('[data-field="length_ft"]');
        const panelS = tr.querySelector('[data-field="panel"]');
        const fastenerS = tr.querySelector('[data-field="fastener"]');
        const patternS = tr.querySelector('[data-field="pattern"]');
        const spaceI = tr.querySelector('[data-field="spacing_mm"]');
        const edgeI = tr.querySelector('[data-field="edge_mm"]');
        const L = toNumber(lenI.value);
        const panel = panelS.value;
        const fastener = fastenerS.value;
        const pattern = patternS.value;
        const spacing = toNumber(spaceI.value);
        const edge = toNumber(edgeI.value);

        const timber = timberPerRun(L, pattern);
        const anchors = anchorsPerRun(L, spacing, edge);
        const hbs = hbsPerRun(L, edge);

        tr.querySelector('[data-cell="timber"]').textContent = timber.toLocaleString();
        tr.querySelector('[data-cell="anchors"]').textContent = anchors.toLocaleString();

        totalLen += L;
        totalAnch += anchors;
        totalHBS += hbs;
        totalTimber += timber;

        if (fastener === 'LBA460 nails') totalLBA += timber; else totalLBS += timber;

        // Validation rules
        if (panel === 'C/GL' && pattern === 'TOTAL') {
          warnings.push(`${nameI.value || 'Run'}: Avoid TOTAL pattern for C/GL under shear.`);
        }
        if (panel === 'C/GL' && fastener === 'LBS560 screws'){
          warnings.push(`${nameI.value || 'Run'}: LBS screws specified for CLT; check edge distances for C/GL.`);
        }
      });

      // Bars with waste
      const waste = toNumber($('#waste').value || 0);
      const barsRaw = (totalLen / BAR_LENGTH_FT) * (1 + waste);
      const bars = ceil(barsRaw);

      // Cap anchors to available holes silently
      let anchors = totalAnch;
      anchors = Math.min(anchors, bars * ANCHORS_PER_BAR);

      // KPIs
      $('#k_total_len').textContent = `${totalLen.toFixed(1)} ft`;
      $('#k_bars').textContent = bars.toLocaleString();
      $('#k_anchors').textContent = anchors.toLocaleString();
      $('#k_membrane').textContent = `${totalLen.toFixed(1)} ft`;
      $('#k_lba').textContent = totalLBA.toLocaleString();
      $('#k_lbs').textContent = totalLBS.toLocaleString();
      $('#k_hbs').textContent = totalHBS.toLocaleString();
      $('#k_jigi').textContent = ceil(totalLen / JIG_INTERVAL_FT).toLocaleString();

      const corners = toNumber($('#corners').value);
      const tees = toNumber($('#tees').value);
      $('#k_jigl').textContent = (corners + 2*tees).toLocaleString();

      // Table totals
      $('#totTimber').textContent = totalTimber.toLocaleString();
      $('#totAnch').textContent = anchors.toLocaleString();

      // Validation output
      $('#validation').textContent = warnings.join('  •  ');
      renderOrder();
    }

    // Build Order Summary table
    const orderBody = document.querySelector('#orderBody');
    function renderOrder(){
      if (!orderBody) return;
      // pull displayed KPIs
      const bars = Number(($('#k_bars')?.textContent||'0').replace(/,/g,''))||0;
      const anchors = Number(($('#k_anchors')?.textContent||'0').replace(/,/g,''))||0;
      const hbs = Number(($('#k_hbs')?.textContent||'0').replace(/,/g,''))||0;
      const lba = Number(($('#k_lba')?.textContent||'0').replace(/,/g,''))||0;
      const lbs = Number(($('#k_lbs')?.textContent||'0').replace(/,/g,''))||0;
      const jigi = Number(($('#k_jigi')?.textContent||'0').replace(/,/g,''))||0;
      const jigl = Number(($('#k_jigl')?.textContent||'0').replace(/,/g,''))||0;
      const totalLen = parseFloat(($('#k_total_len')?.textContent||'0').replace(/[^0-9.]/g,''))||0;
      const state = serialize();
      const lbaCode = state.meta.nail_gun==='ATEU0116' ? 'LBA34PLA460' : (state.meta.nail_gun==='HH3522' ? 'LBA25PLA460' : '');
      const rows = [
        {product:'ALUSTART bars', code:state.meta.sku_alustart||'', qty:bars},
        {product:'Membrane under profile (ft)', code:state.meta.sku_membrane||'', qty:totalLen.toFixed(1)},
        {product:'Concrete fastener', code:'SKREVO12100', qty:anchors},
        {product:'HBS screw (Ø0.32")', code:'HBS880', qty:hbs},
        {product:'Timber fasteners – LBA460 nails', code:lbaCode, qty:lba},
        {product:'Timber fasteners – LBS560 screws', code:'', qty:lbs},
        {product:'JIGSTARTI', code:'JIGSTARTI', qty:jigi},
        {product:'JIGSTARTL', code:'JIGSTARTL', qty:jigl}
      ];
      orderBody.innerHTML = rows.map(r=>`<tr><td>${r.product}</td><td contenteditable="true">${r.code||'—'}</td><td class="num">${(r.qty||0).toLocaleString()}</td></tr>`).join('');
    }

    // ======== Save/Load/Reset/CSV/Print ========
    function serialize(){
      const rows = $$('.run-card').map(tr =>{
        const nameI = tr.querySelector('input[type="text"]');
        const lenI = tr.querySelector('[data-field="length_ft"]');
        const panelS = tr.querySelector('[data-field="panel"]');
        const fastenerS = tr.querySelector('[data-field="fastener"]');
        const patternS = tr.querySelector('[data-field="pattern"]');
        const spaceI = tr.querySelector('[data-field="spacing_mm"]');
        const edgeI = tr.querySelector('[data-field="edge_mm"]');
        return {
          name: nameI.value,
          length_ft: toNumber(lenI.value),
          panel: panelS.value,
          fastener: fastenerS.value,
          pattern: patternS.value,
          spacing_mm: toNumber(spaceI.value),
          edge_mm: toNumber(edgeI.value)
        };
      });
      // Resolve current ALUSTART SKU from UI before building payload
      const selVal = (document.getElementById('sku_alustart_select')||{}).value || '';
      const skuVal = selVal === '__custom' ? (document.getElementById('sku_alustart')||{}).value : (selVal || (document.getElementById('sku_alustart')||{}).value);
      return { meta: {
          job: $('#job').value,
          sku_alustart: skuVal,
          sku_membrane: $('#sku_membrane').value,
          nail_gun: $('#nail_gun').value,
          waste: toNumber($('#waste').value),
          corners: toNumber($('#corners').value),
          tees: toNumber($('#tees').value)
        },
        rows
      };
    }

    function setSkuAlustart(value){
      const sel = document.getElementById('sku_alustart_select');
      const input = document.getElementById('sku_alustart');
      if (!sel || !input) return;
      // Try to match an existing option
      const match = Array.from(sel.options).find(o=>o.value===value || o.text===value);
      if (match && match.value !== '__custom' && match.value !== ''){
        sel.value = match.value || match.text;
        input.style.display = 'none';
        input.value = match.value || match.text;
      } else if (value){
        sel.value = '__custom';
        input.style.display = '';
        input.value = value;
      } else {
        sel.value = '';
        input.style.display = 'none';
        input.value = '';
      }
    }

    function deserialize(state){
      if (!state) return;
      $('#job').value = state.meta?.job || '';
      setSkuAlustart(state.meta?.sku_alustart || '');
      $('#sku_membrane').value = state.meta?.sku_membrane || '';
      $('#nail_gun').value = state.meta?.nail_gun || '';
      $('#waste').value = state.meta?.waste ?? 0.05;
      $('#corners').value = state.meta?.corners ?? 0;
      $('#tees').value = state.meta?.tees ?? 0;

      runlist.innerHTML = '';
      (state.rows || []).forEach(r=> addRow(r));
      if ((state.rows || []).length === 0) addRow();
      computeAll();
    }

    function save(){
      const data = serialize();
      localStorage.setItem('alustart_calc_v1', JSON.stringify(data));
      alert('Saved in this browser.');
    }

    function load(){
      const raw = localStorage.getItem('alustart_calc_v1');
      if (!raw){ alert('No saved data found.'); return; }
      try{ deserialize(JSON.parse(raw)); } catch(e){ alert('Could not load saved data.'); }
    }

    function resetAll(){
      if(!confirm('Clear all inputs?')) return;
      $('#job').value = '';
      setSkuAlustart('');
      $('#sku_membrane').value = '';
      $('#nail_gun').value = '';
      $('#waste').value = 0.05;
      $('#corners').value = 0;
      $('#tees').value = 0;
      runlist.innerHTML = '';
      addRow();
      computeAll();
    }

    function buildCSV(state){
      // Recompute from state to ensure deterministic output
      let totalLen=0, totalTimber=0, totalAnch=0, totalLBA=0, totalLBS=0, totalHBS=0;
      const lines = [];
      lines.push(`Job,${state.meta.job||''}`);
      lines.push(`ALUSTART SKU,${state.meta.sku_alustart||''}`);
      lines.push(`Membrane SKU,${state.meta.sku_membrane||''}`);
      lines.push(`Nail Gun,${state.meta.nail_gun||''}`);
      lines.push(`Waste Factor,${state.meta.waste}`);
      lines.push(`Corners,${state.meta.corners}`);
      lines.push(`T-Intersections,${state.meta.tees}`);
      lines.push('');
      lines.push('Run,Length ft,Panel,Fastener,Pattern,Spacing mm,Edge mm,Timber fasteners,Anchors');

      state.rows.forEach(r=>{
        const timber = timberPerRun(r.length_ft, r.pattern);
        const anchors = anchorsPerRun(r.length_ft, r.spacing_mm, r.edge_mm);
        const hbs = hbsPerRun(r.length_ft, r.edge_mm);
        lines.push(`${r.name},${r.length_ft},${r.panel},${r.fastener},${r.pattern},${r.spacing_mm},${r.edge_mm},${timber},${anchors}`);
        totalLen += r.length_ft; totalTimber += timber; totalAnch += anchors; totalHBS += hbs;
        if (r.fastener==='LBA460 nails') totalLBA += timber; else totalLBS += timber;
      });

      const bars = ceil((totalLen/BAR_LENGTH_FT)*(1+state.meta.waste));
      let anchors = totalAnch;
      anchors = Math.min(anchors, bars*ANCHORS_PER_BAR);

      lines.push(``);
      lines.push(`Totals,,,,,,,${totalTimber},${anchors}`);
      lines.push(`Total Length ft,${totalLen}`);
      lines.push(`Bars,${bars}`);
      lines.push(`Anchors (final),${anchors}`);
      lines.push(`HBS880 Screws,${totalHBS}`);
      lines.push(`Membrane ft,${totalLen.toFixed(1)}`);
      lines.push(`JIGSTARTI,${ceil(totalLen/JIG_INTERVAL_FT)}`);
      lines.push(`JIGSTARTL,${(state.meta.corners + 2*state.meta.tees)}`);
      lines.push(`LBA460 Nails,${totalLBA}`);
      lines.push(`LBS560 Screws,${totalLBS}`);

      // Order Summary
      lines.push('');
      lines.push('Order Summary');
      lines.push('Product,Code,Quantity');
      const lbaCode = state.meta.nail_gun==='ATEU0116' ? 'LBA34PLA460' : (state.meta.nail_gun==='HH3522' ? 'LBA25PLA460' : '');
      const barsFinal = bars;
      const anchorsFinal = anchors;
      const rowsOS = [
        ['ALUSTART bars', (state.meta.sku_alustart || '') , barsFinal],
        ['Membrane under profile (ft)', (state.meta.sku_membrane || ''), totalLen.toFixed(1)],
        ['Concrete fastener', 'SKREVO12100', anchorsFinal],
        ['HBS screw (Ø0.32\")', 'HBS880', totalHBS],
        ['Timber fasteners – LBA460 nails', lbaCode, totalLBA],
        ['Timber fasteners – LBS560 screws', '', totalLBS],
        ['JIGSTARTI', 'JIGSTARTI', ceil(totalLen/JIG_INTERVAL_FT)],
        ['JIGSTARTL', 'JIGSTARTL', (state.meta.corners + 2*state.meta.tees)]
      ];
      rowsOS.forEach(r=> lines.push(`${r[0]},${r[1]},${r[2]}`));

      return lines.join('\n');
    }

    function exportCSV(){
      computeAll();
      const state = serialize();
      const csv = buildCSV(state);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:T]/g,'-').split('.')[0];
      a.href = url; a.download = `ALUSTART_takeoff_${ts}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ======== Wiring ========
    // Compact mode toggle
    const COMPACT_KEY = 'alustart_compact';
    const toggleBtnInit = () => {
      const btn = document.querySelector('#toggleCompact');
      if (!btn) return;
      const apply = (on) => { document.body.classList.toggle('compact', on); btn.textContent = on ? 'Compact layout: ON' : 'Compact layout: OFF'; };
      const saved = localStorage.getItem(COMPACT_KEY);
      apply(saved !== '0'); // default ON if null
      btn.addEventListener('click', ()=>{ const now = !document.body.classList.contains('compact'); apply(now); localStorage.setItem(COMPACT_KEY, now? '1':'0'); });
    };
    document.addEventListener('DOMContentLoaded', toggleBtnInit);

    // ---- ALUSTART SKU: draggable presets + dropdown/custom combo ----
    const PRESET_SKUS = ['ALUSTART80','ALUSTART100','ALUSTART120','ALUSTART140','ALUSTART160'];
    const strip = document.getElementById('sku_strip');
    if (strip){ strip.innerHTML = PRESET_SKUS.map(s=>`<span class="sku-pill" draggable="true" data-sku="${s}">${s}</span>`).join('');
      strip.addEventListener('dragstart', e=>{ const t = e.target.closest('.sku-pill'); if(!t) return; e.dataTransfer.setData('text/plain', t.dataset.sku); });
    }
    const skuSelect = document.getElementById('sku_alustart_select');
    const skuInput = document.getElementById('sku_alustart');
    if (skuSelect && skuInput){
      [skuSelect, skuInput].forEach(el=>{
        el.addEventListener('dragover', e=>{ e.preventDefault(); el.classList.add('drop-target'); });
        el.addEventListener('dragleave', ()=> el.classList.remove('drop-target'));
        el.addEventListener('drop', e=>{ e.preventDefault(); el.classList.remove('drop-target'); const val = e.dataTransfer.getData('text/plain'); setSkuAlustart(val); computeAll(); });
      });
      skuSelect.addEventListener('change', ()=>{
        if (skuSelect.value === '__custom') { skuInput.style.display=''; if(!skuInput.value) skuInput.focus(); }
        else { skuInput.style.display='none'; skuInput.value=''; }
        if (skuSelect.value && skuSelect.value !== '__custom') skuInput.value = skuSelect.value; // keep hidden storage in sync
        computeAll();
      });
    }

    // General inputs -> recompute
    ['#job','#sku_alustart','#sku_alustart_select','#sku_membrane','#nail_gun','#waste','#corners','#tees']
      .forEach(sel=>{ const el = $(sel); if(el){ el.addEventListener('input', computeAll); el.addEventListener('change', computeAll);} });

    // Show constants in UI
    $('#bl').textContent = BAR_LENGTH_FT.toFixed(3);
    $('#apb').textContent = ANCHORS_PER_BAR;
    $('#ji').textContent = JIG_INTERVAL_FT.toFixed(3);

    // Startup
    addRow({ name: 'Run 1', length_ft: 20, panel: 'CLT', fastener: 'LBA460 nails', pattern: 'TOTAL', spacing_mm: 200, edge_mm: 100 });
    computeAll();

    // ======== Simple Test Suite ========
    function runTests(){
      const out = [];
      const assert = (cond, msg) => { if(!cond){ out.push('❌ '+msg); } else { out.push('✅ '+msg); } };
      // Anchors at 200mm, 100mm edge each side, 10 ft
      const a1 = anchorsPerRun(10,200,100); // L=3048mm, usable=2848 => 1 + floor(2848/200)=1+14=15
      assert(a1===15, `anchorsPerRun basic (got ${a1})`);
      // HBS at 300mm
      const h1 = hbsPerRun(10,100); // usable=2848 => 1+floor(2848/300)=1+9=10
      assert(h1===10, `hbsPerRun basic (got ${h1})`);
      // Timber density TOTAL 22 pcs/ft
      const t1 = timberPerRun(3.2,'TOTAL');
      assert(t1===Math.ceil(3.2*22), `timberPerRun TOTAL (got ${t1})`);
      // CSV builder smoke tests
      const sample = { meta:{job:'T1',sku_alustart:'ALUSTART120',sku_membrane:'MBR',nail_gun:'ATEU0116',waste:0.05,corners:2,tees:1},
        rows:[{name:'Run 1',length_ft:20,panel:'CLT',fastener:'LBA460 nails',pattern:'TOTAL',spacing_mm:200,edge_mm:100}] };
      const csv = buildCSV(sample);
      assert(csv.includes('Job,T1'), 'CSV includes Job');
      assert(csv.includes('ALUSTART SKU,ALUSTART120'), 'CSV includes ALUSTART SKU');
      assert(csv.includes('HBS880'), 'CSV includes HBS line');
      $('#testOutput').textContent = out.join('\n');
    }
    const testBtn = document.getElementById('runTestsBtn');
    if (testBtn) testBtn.addEventListener('click', runTests);
  </script>
</body>
</html>
